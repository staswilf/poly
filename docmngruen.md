# Выпуск двуязычной конфигурации "1С:Документооборот 2.1"

## Общие сведения

Выпуск двуязычной конфигурации сводится к:
1. Загрузке русскоязычной конфигурации в инструмент перевода;
2. Переводу в нем новых и измененных объектов;
3. Созданию файла поставки переведенной конфигурации;
4. Обновлению хранилища двуязычной конфигурации файлом поставки.

## Загрузка русскоязычной конфигурации

Русскоязычную конфигурацию берем из сборки, не из хранилища, чтобы гарантировать соответствие релиза двуязычной конфигурации релизу русскоязычной. Конфигурация выгружается в файлы платформой версии, рекомендуемой для конфигурации.

## Перевод

Файлы русскоязычной конфигурации загружаются в инструмент перевода без дополнительных настроек ("Mark as invalid" заставит программу пометить все объекты перевода как неактуальные, а потом снять эту пометку у всех загружаемых объектов, что в реальности никому не нужно, мы все равно обращаем внимание только на новые и измененные объекты).
Перед загрузкой рекомендуется сделать резервную копию.

Далее следует распределить работу по ответственным, глядя на РС "Statistics on translation objects by configuration objects". Записи без объектов перевода - это итоги по ответственным, запись без объекта перевода и ответственного - это общий итог. Как правило, если объектов к переводу меньше 1000, дешевле оказывается перевести все самому. Если объектов больше, нужно раздать их по ответственным, следя, чтобы объем был по возможности одинаков, а объекты конфигурации были знакомы ответственным (это противоречивые требования).
Для передачи объекта конфигурации другому ответственному служит команда контекстного меню "Specify responsible user". Автоматического обновления статистики при этом не происходит, нужно дождаться запуска регламентного задания или обновить вручную командой "Update statistics".

Перевод начинается с запуска инструмента перевода под ответственными со включением режима "My objects only" и установки фильтра по объектам "Unverified". Этот фильтр покажет новые объекты, измененные объекты и объекты с автопереводом, требующие верификации.
Собственно перевод заключается в двух операциях:
* Для качественных автопереводов нужно выбрать команду "Verify".
* Для новых и измененных объектов и некачественных автопереводов нужно выбрать команду "Translate" или открыть объект двойным щелчком и дать качественный перевод, пользуясь словарями и автопереводом. Ускорить процесс можно, пакетно переводя идентичные объекты командой "Translate identical ones".

Нюансы:
* Инструмент перевода следит за совпадением числа апострофов и знаков процента. При необходимости обойти этот контроль нужно открыть форму объекта перевода (F2) и исправить перевод там.
* Для автоперевода используется сперва Яндекс-переводчик, а потом MS Translate. Ключ Яндекс-переводчика хранится в ИБ. Ключ MS Translate захардкоден. Автопереводы кэшируются.
* Названия адресных объектов не переводим (русскоязычный адрес собирается из "ул", "б-р" и проч)
* Форматы дублируем

После завершения перевода вызываем команду "Translate configuration". В качестве исходного каталога указываем каталог с выгрузкой русскоязычной конфигурации - например, тот, что мы использовали при загрузке, а в качестве каталога назначения - любой пустой. Перевод плохо оптимизирован и занимает 1-2 часа. Заметная его часть - передача файлов с клиента на сервер; ее можно ускорить, дав возможность указывать сетевые каталоги, доступные с сервера.

### Создание файла поставки переведенной конфигурации

Хранилище двуязычной конфигурации **ДокументооборотКОРПРусскийИАнглийскийИнтерфейс** находится на поддержке конфигурации **DocumentManagementBilingual**. Чтобы ее создать, нужно:
1. Загрузить переведенные файлы в пустую конфигурацию.
 * Ошибки в ссылках на картинки (например, в справке) игнорируем, они не привнесены переводом и случаются и при обычной выгрузке и загрузке.
 * Включить возможность изменения или снять с поддержки.
2. Сравнением-объединением с конфигурацией **DocumentManagementBilingual** взять из нее имя конфигурации (и, неявно, идентификатор), язык "Английский" и свойство "Основной язык". 
 * Никакого другого содержания у этой конфигурации нет.
 * Это просто способ создать файл поставки для хранилища двуязычной конфигурации с идентификатором, отличным от идентификатора русскоязычной конфигурации ДокументооборотКОРП (при объединении вместе с именем конфигурации загружается и ее идентификатор).
 * На вопрос "Поставить на поддержку" лучше ответить нет, только потому, что так быстрее.
3. Создать файл поставки для обновления хранилища двуязычной конфигурации.

### Обновление хранилища

Хранилище двуязычной конфигурации **ДокументооборотКОРПРусскийИАнглийскийИнтерфейс** обновляем, как обычно, после захвата всех объектов, обновлением на файлы поставки **DocumentManagementBilingual**. Занимает это 3-4 часа. При этом мы:

* Вручную собираем общий модуль **ОбновлениеИнформационнойБазыДокументооборот**:
  * Взяв из новой конфигурации версию
  * Взяв из новой конфигурации обработчики обновления
  * Проверив, не изменились ли в конфигурации поставщика обработчики обновления предыдущих версий
  * Дополнив вызовом ЛокализацияКонфигурацииПереопределяемый.ПерейтиНаВерсию<...>, если необходимо дать двуязычные наименования новым предопределенным элементам
  
* Проверяем, чтобы наименования новых регламентных заданий были очищены 
  * Наличие наименования - нарушение стандарта по локализации и ошибка, которая после выявления должна быть исправлена и в русскоязычной конфигурации
  
* Ищем новые предопределенные элементы и даем им двуязычные наименования
  * В обработчике ЛокализацияКонфигурацииПереопределяемый.ПерейтиНаВерсию<...>, вызовом ОбновитьПредопределенныйЭлемент
  * Инструмента по поиску новых предопределенных элементов нет. Можно было бы сделать, но проще перейти на механику БСП 3.1 (см. ниже).
  
* Разбираемся с новыми и измененными схемами компоновки данных отчетов
  * Новые - переводим вручную
    * Не забывая про заголовки таблиц и диаграмм на закладке "Настройка"
  * Слегка измененные - правим по месту в двуязычной конфигурации
  * Сильно измененные - берем из новой конфигурации и переводим вручную
  * **Самый трудоемкий пункт**
  
* Разбираемся с измененными макетами типа "Табличный документ"
  * Как правило, требуются точечные правки, поскольку макеты в русскоязычной конфигурации меняются редко
  * Чаще всего - в макетах справочника НастройкиДоступностиПоСостоянию
    * Переводится вторая колонка, "ПредставлениеПоляКоманды"
  * Содержимое ячеек редактируем на двух языках нажатием кнопки с лупой, прямое редактирование меняет только текст на текущем языке редактирования конфигурации
  
* Берем изменения в нескольких формах, содержащих форматированные строки, которые Конфигуратор почему-то считает измененными в сравнении со старой конфигурацией поставщика
  * Это какая-то ошибка Конфигуратора
  * НастройкиПравПапок, НастройкиПроверкиКонтрагентов и пр
  
* Оставляем изменения в общих картинках
  * Русскоязычные картинки вроде [К] заменены в двуязычной на интернациональные
    
* Разбираемся с изменениями в модулях, снятых с поддержки, например:
  * ШаблоныДокументов, ШаблоныБизнесПроцессов
    * В двуязычной сделан цикл по языкам, чтобы воспринять автоподстановки на любом языке. Хорошо бы погрузить в русскоязычную и поставить на поддержку.
  * Пользователи
    * В двуязычной создается Администратор или Administrator.
  * АвтозаполнениеШаблоновФайловСервер
    * Исправление ошибки, которую должны были погрузить в русскоязычную (А.Гацков)
  * СтандартныеПодсистемыСервер
    * Отключаем установку региональных настроек при первом запуске, чтобы пользователи не настроили себе основной язык, отличный от установленного в свойствах конфигурации - этот механизм БСП 3.1 двуязычная конфигурация пока не поддерживает. Не поддерживает и мультиязычные наименования (надо будет сделать к 3.0)

* Генерируем подпись мобильного клиента (К.Малахов).

* Запускаем проверку конфигурации, ловим ошибки.
  
## На будущее

В БСП 3.1 появились общие реквизиты, хранящие наименования на одном или двух дополнительных языках. Можно реализовать давно запрашиваемую пользователями возможность задавать наименования на двух языках. Но нужно, во-первых, определить контур этого проекта (какие справочники поддержим, а какие нет) и, во-вторых, подумать над сценариями (кто будет вводить название контрагента на другом языке? когда и как? а если он загружен из другой базы?).

В БСП 3.1 появилась возможность задавать локализованные наименования предопределенных элементов в менеджерах самих объектов МД. Свой механизм, через ЛокализацияКонфигурацииПереопределяемый, мы сделали до появления аналогичного механизма в БСП. Сейчас пора вернуться к БСПшному механизму.

Шаг обновления на промежуточную конфигурацию **DocumentManagementBilingual** можно пропустить, если научить инструмент перевода подменять при переводе имя конфигурации и идентификатор (опционально - добавлять английский язык и назначать его основным).
